#include "Loom_EZORGB.h"

//////////////////////////////////////////////////////////////////////////////////////////////////////
Loom_EZORGB::Loom_EZORGB(Manager& man, byte address, bool useMux) : EZOSensor("EZO-RGB"), manInst(&man){
    i2c_address = address;
    module_address = i2c_address;

    if(!useMux)
        manInst->registerModule(this);
}
//////////////////////////////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////////////////////////
void Loom_EZORGB::initialize(){
    Wire.begin();
    moduleInitialized = calibrate();
}
//////////////////////////////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////////////////////////
void Loom_EZORGB::measure(){
    if(moduleInitialized){

        // Attempt to read data from the sensor
        if(!readSensor()){
            ERROR("Failed to read sensor!");
            return;
        }

        // Parse the constructed string
        parseData(getSensorData());
    }
}
//////////////////////////////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////////////////////////
void Loom_EZORGB::package(){
    if(moduleInitialized){
        JsonObject json = manInst->get_data_object(getModuleName());
        json["Red"] = rgb[0];
        json["Green"] = rgb[1];
        json["Blue"] = rgb[2];
    }
}
//////////////////////////////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////////////////////////
void Loom_EZORGB::power_down() {
    if(moduleInitialized){
        if(!sendTransmission("sleep")){
            ERROR("Failed to send 'sleep' command to device");
        }
    }
}
//////////////////////////////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////////////////////////
void Loom_EZORGB::parseData(String sensorData){
    // Parse out the comma separated strings
    rgb[0] = sensorData.substring(0, sensorData.indexOf(",")).toInt();
    rgb[1] = sensorData.substring(sensorData.indexOf(","), sensorData.indexOf(",", sensorData.indexOf(","))).toInt();
    rgb[2] = sensorData.substring(sensorData.indexOf(",", sensorData.indexOf(",")), sensorData.indexOf(",", sensorData.indexOf(",", sensorData.indexOf(",")))).toInt();
}
//////////////////////////////////////////////////////////////////////////////////////////////////////