#include "Loom_ADS1232.h"
#include "Logger.h"

//////////////////////////////////////////////////////////////////////////////////////////////////////
Loom_ADS1232::Loom_ADS1232(Manager& man, int num_samples, long offset, float scale) : Module("ADS1232"), manInst(&man), inst(ADS1232_Lib(A2, A1, A0)) {
    // Set offset, scale, and number of samples
    this->offset = offset;
    this->scale = scale;
    this->num_samples = num_samples;
    manInst->registerModule(this);
}
//////////////////////////////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////////////////////////
void Loom_ADS1232::initialize(){
    inst.set_offset(this->offset);
    inst.set_scale(this->scale);
    power_up();
}
//////////////////////////////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////////////////////////
void Loom_ADS1232::power_up(){
    // Turn on pins for SPI communication
    inst.power_up();
}
//////////////////////////////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////////////////////////
void Loom_ADS1232::power_down(){
    // Disable pins to save power
    inst.power_down();
}
//////////////////////////////////////////////////////////////////////////////////////////////////////
        
//////////////////////////////////////////////////////////////////////////////////////////////////////
void Loom_ADS1232::measure(){
    if(inst.is_ready()){
        weight = inst.units_read(num_samples);
    }else{
        WARNING("ADS1232 is not ready to collect data!");
    }
}
//////////////////////////////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////////////////////////
void Loom_ADS1232::package(){
    JsonObject json = manInst->get_data_object(getModuleName());
    json["weight"] = weight;
}
//////////////////////////////////////////////////////////////////////////////////////////////////////